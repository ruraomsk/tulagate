# Спецификация

## Команда для генерации прото файлов
protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative ami.proto

## Перечень действий

- **Status**
Периодическое (например, раз в сек) получение текущего статуса контроллра. Инициатор действия клиент.
В теле ответа возвращается структура:
```json
{
	"program_number": int,            // Номер программы
	"phase_number": int,              // Номер фазы
	"tact_number": int,               // Номер такта в фазе
	"tact_tick": int,                 // Тик такта
	"hold_phase_number": int,         // Номер фазы для удержания
	"host": "string",                 // IP адрес подключенного устройства
	"port": int,                      // Порт подключенного устройства
	"state": "int",                   // Статус контроллера в сети: 0 - нет связи, 1 - есть связь нет управления, 2 - есть связь есть управление
	"errors": {
		"hw_error": []string,         // Массив ошибок, связанных с железом
	  	"sw_error": []string,         // Массив ошибок, связанных с ПО
	  	"ec_error": []string,         // Массив ошибок, связанных с электрикой (например, кз)
	  	"detector_fault": []string,   // Массив ошибок, связанных с детектором
	  	"is_door_opened": bool,       // Состояние открытия/закрытия двери
	},                                // Описание ошибок
	"mode": int,                      // Текущий режим: 1 - локальный, 2 - удаленное (центральное) управление, 3 - желтое мигание, 4 - кругом красный, 5 - все светофоры выключенны, 6 - ручное (местное) управление, 7 - удержание фазы, 8 - зеленая улица
	"timestamp": int64,               // Время на контроллере
	"vac": float64,                   // Текущее напряжение на контроллере
	"channels_powers": []float64,     // Массив потребляемой мощьности по каналам контроллера
	"channels_state": [
        {
            "low_power": bool,              // Флаг выхода за нижний порог
            "high_power": bool,             // Флаг выхода за верхний порог
            "ext_voltage_while_off": bool,  // Флаг наличия напряжения в режиме, когда его быть не должно
            "no_voltage_while_on": bool,    // Флаг отсутствия напряжения в режиме, когда оно должно быть
            "voltage_presence": bool,       // Флаг наличия напряжения
            "is_valid": bool,               // Флаг валидности данных
            "is_enabled": bool,             // Флаг того, что канал включен
        }           
	],                                // Состояния каналов контроллера
	"conflict_config": bool,          // Флаг наличия конфликта конфигураций
	"hold_phase_time_remain": int,    // Таймер обратного отсчета до конца удержания фазы, в сек
}
```

- **SetMode**
Установка режима работы контроллера. Инициатор действия сервер.
В теле запроса приходит следующая структура:
```json
{
    "mode": int,        // 3 - желтое мигание, 4 - кругом красный, 5 - все светофоры выключенны 
    "is_enabled": bool, // Включить / Выключить
}
```

- **HoldPhase**
Включение удержания заднной фазы. Переводит поле mode в структуре ответа на действие Status в значение "удержание фазы". Инициатор действия сервер. В теле запроса приходит следующая структура:
```json
{
    "phase_number": int,    // Номер фазы
    "max_duration": int,    // Максимальное время удержания фазы в секундах
    "unhold_phase": bool,   // Флаг снятия удержания фазы
}
```

- **SwitchProgram**
Установка программы на контроллере. Инициатор действия сервер. 
В теле запроса приходит следующая структура:
```json
{
    "program_number": int,  // Номер программы
    "switch_default": bool, // Флаг установки значения по умолчанию
}
```

- **Reset**
Перезагрузка контроллера. Инициатор действия сервер. 
Тело запроса пустая строка.

- **StartCoordination**
Включение плана координации. Инициатор действия сервер. 
В теле запроса приходит следующая структура:
```json
{
    "program_number": int,  // Номер программы
    "phases": [
        {
            "phase_number": int,    //Номер фазы
            "phase_duration": int,  //Время фазы в секундах
            "phase_order": int,     //Порядок фазы в программе
            "max_time": int,        //Максимальная граница
            "min_time": int,        //Минимальная граница
        }
    ],                      // Список фаз
    "offset": int,          // Смещение начала программы в сек
    "isEnabled": bool,      // Вкл / Выкл
}
```

## Структура возвращаемой ошибки

Все действия, иницируемые сервером вместо данных, в теле ответа могут получить сообщение об ошибке.
Формат сообщения:
```json
{
    "error": "string" // Сообщение об ошибке
}
```